let spells = [
     {
        "key" : "Accio",
        "val" : "Brings an object to you"
    }, {
        "key" : "Aguamenti",
        "val" : "Creates a gush of water from the tip of the spell caster’s wand"
    }, {
        "key" : "Alohomora",
        "val" : "Opens locks"
    }, {
        "key" : "Aparecium",
        "val" : "Makes invisible ink become visible"
    }, {
        "key" : "Avada Kedavra",
        "val" : "Kills your opponent"
    }, {
        "key" : "Avifors",
        "val" : "Turns things into birds"
    }, {
        "key" : "Avis",
        "val" : "Makes birds fly out of the end of your wand"
    }, {
        "key" : "Bombarda",
        "val" : "Causes a small, locally contained explosion"
    }, {
        "key" : "Colloportus",
        "val" : "Closes a door and binds it so that it can’t be opened"
    }, {
        "key" : "Confringo",
        "val" : "Causes the item targeted to explode"
    }, {
        "key" : "Confundus",
        "val" : "Confounds your target, or makes them temporarily confused"
    }, {
        "key" : "Conjunctivitis",
        "val" : "Damages the eyesight of your opponent, making them seem to have pink eye"
    }, {
        "key" : "Crucio",
        "val" : "Tortures your opponent mercilessly (The Second Unforgivable Curse)"
    }, {
        "key" : "Deletrius",
        "val" : "Erases the last spell cast by a wand so that it can’t be discovered"
    }, {
        "key" : "Densaugeo",
        "val" : "Makes teeth grow out of control"
    }, {
        "key" : "Diffindo",
        "val" : "Makes seams split open, severs an object into two pieces"
    }, {
        "key" : "Dissendium",
        "val" : "Opens a specific passageway into a cellar, may be useful in other instances; may be only a password"
    }, {
        "key" : "Duro",
        "val" : "Turns an item to stone"
    }, {
        "key" : "Engorgio",
        "val" : "Makes an item larger, as in swollen"
    }, {
        "key" : "Episkey",
        "val" : "Heals relatively minor wounds"
    },{
        "key" : "Evanesco",
        "val" : "Causes an item to immediately dissolve away, as if it had never existed"
    }, {
        "key" : "Expecto Patronum",
        "val" : "Creates Patronus"
    }, {
        "key" : "Expelliarmus",
        "val" : "Disarms the target of the spell, such as knocking their wand out of their hand"
    }, {
        "key" : "Fera Verto",
        "val" : "Transforms animals into water goblets"
    }, {
        "key" : "Ferula",
        "val" : "Binds a broken limb with a splint and bandages, tightly wrapped"
    }, {
        "key" : "Fidelius",
        "val" : "Allows a secret to be hidden within the secret keeper’s soul; very powerful spell"
    }, {
        "key" : "Finite Incantatem",
        "val" : "Stops any spell"
    },{
        "key" : "Flagrate",
        "val" : "Allows the user to write or draw in the air with fire"
    }, {
        "key" : "Flipendo",
        "val" : "Pushes or flips something backwards"
    }, {
        "key" : "Furnunculus",
        "val" : "Causes a person to break out in boils"
    }, {
        "key" : "Geminio",
        "val" : "Creates a duplicate of an item"
    }, {
        "key" : "Homorphus",
        "val" : "Makes a werewolf or person disguised as an animal resume their human shape"
    }, {
        "key" : "Immobulus",
        "val" : "Immobilizes the target"
    }, {
        "key" : "Impedimenta",
        "val" : "Puts up an impediment that slows down something or someone that is coming toward you"
    }, {
        "key" : "Imperio",
        "val" : "Allows the user to assume complete control of another person (The third unforgivable curse)"
    },{
        "key" : "Impervius",
        "val" : "Repels water from a surface"
    }, {
        "key" : "Incarcerous",
        "val" : "Conjures up ropes, which then bind an opponent"
    }, {
        "key" : "Incendio",
        "val" : "Lights a fire"
    }, {
        "key" : "Legilimens",
        "val" : "Allows the user to gain access to another’s mind and memories"
    }, {
        "key" : "Levicorpus",
        "val" : "Turns your opponent upside down and dangles them in thin air"
    },{
        "key" : "Liberacorpus",
        "val" : "\"Liberates\", or frees a body that has been caught up by the levicorpus spell"
    }, {
        "key" : "Locomotor Mortis",
        "val" : "Locks an opponent’s legs together"
    },{
        "key" : "Lumos",
        "val" : "Creates light, usually by making the tip of the wand glow"
    }, {
        "key" : "Mobiliarbus",
        "val" : "Moves a tree from one place to another"
    }, {
        "key" : "Mobilicorpus",
        "val" : "Moves a body from one place to another"
    }, {
        "key" : "Morsmordre",
        "val" : "Summons the Dark Mark"
    }, {
        "key" : "Muffliato",
        "val" : "Causes a buzzing noise to surround a limited area so that those in the area can carry on a private conversation"
    }, {
        "key" : "Nox",
        "val" : "Extinguishes light, used to douse the light created by “Lumos”"
    }, {
        "key" : "Obliviate",
        "val" : "Makes a person \"oblivious\", erasing their memories of an event"
    }, {
        "key" : "Orchideous",
        "val" : "Conjures a bunch of flowers from the user’s wand"
    }, {
        "key" : "Petrificus Totalus",
        "val" : "Petrifies an opponent totally"
    }, {
        "key" : "Point Me",
        "val" : "Makes the user’s wand act like a compass"
    }, {
        "key" : "Portus",
        "val" : "Turns any item into a Portkey, which can then be used to transport a person or persons to another location"
    },{
        "key" : "Prior Incantato",
        "val" : "Reveals to you the last spell that a wand was used to cast"
    }, {
        "key" : "Protego",
        "val" : "Protects the user, and sends a spell back on an opponent"
    }, {
        "key" : "Quietus",
        "val" : "Makes things quiet, used to muffle \"Sonorus\""
    }, {
        "key" : "Reducio",
        "val" : "Shrinks an item"
    },{
        "key" : "Reducto",
        "val" : "Blasts solid objects into pieces"
    }, {
        "key" : "Relashio",
        "val" : "Releases something from being constrained or held"
    }, {
        "key" : "Rennervate",
        "val" : "Means to energize or wake up"
    }, {
        "key" : "Reparo",
        "val" : "Repairs broken items"
    }, {
        "key" : "Repello",
        "val" : "Repels something"
    }, {
        "key" : "Repello Muggletum",
        "val" : "Makes an area invisible to Muggles"
    }, {
        "key" : "Revelio",
        "val" : "Causes something that is hidden to be revealed"
    }, {
        "key" : "Rictusempra",
        "val" : "Causes a person to curl up in laughter, as if being tickled"
    },{
        "key" : "Riddikulus",
        "val" : "Protects from a boggart by making it funny instead of terrifying"
    }, {
        "key" : "Salvio Hexia",
        "val" : "Strengthens other protective spells, or deflects any hexes cast toward a specific location"
    }, {
        "key" : "Scourgify",
        "val" : "Cleans dirt or other material off of a surface"
    }, {
        "key" : "Sectumsempra",
        "val" : "Causes lacerations to appear all over an opponent’s body, as if they had been cut by an invisible sword"
    }, {
        "key" : "Serpensortia",
        "val" : "Conjures a snake"
    },{
        "key" : "Silencio",
        "val" : "Makes the target of the spell unable to make any sound"
    }, {
        "key" : "Sonorus",
        "val" : "Amplifies the user’s voice"
    },{
        "key" : "Stupefy",
        "val" : "Stupefies an opponent, or knocks them insensible temporarily"
    }, {
        "key" : "Tarantallegra",
        "val" : "Forces an opponent’s legs to dance uncontrollably"
    }, {
        "key" : "Tergeo",
        "val" : "Scours something clean"
    }, {
        "key" : "Waddiwasi",
        "val" : "Removes a stuck object, as in a wad of gum that is stuck in a keyhole"
    }, {
        "key" : "Wingardium Leviosa",
        "val" : "Allows the user to make an object levitate"
    }
];

// ============ VARIBALES =================

let startButton = document.querySelectorAll('.start'),
    newGameButton = document.querySelector('.new-game'),
    numberOfQuestionsLeft = document.querySelector('.questions-left'),
    numberOfCorrectAnswers = document.querySelector('.correct-num'),
    numberOfWrongAnswers = document.querySelector('.wrong-num'),
    score = document.querySelector('.score'),
    timer = document.querySelector('.timer'),
    gameOverField = document.querySelector('.game-over'),
    totalScore = 0,
    spellsUsed = [],
    easyGameTime,
    difficultGameTime,
    currentKey,
    timerFunction,
    gameLevel;

const gameField = document.querySelector('.game-field'), 
    questionField = document.querySelector('.question-field h2'),
    questionIcon = document.querySelector('.question-icon'),
    optionsField = document.querySelector('.options-field'),
    gameText = document.querySelector('.game-text');
    allKeys = _.pluck(spells, 'key');


// ============ EVENT LISTENERS =================

startButton.forEach(btn => {
    btn.addEventListener('click', startGame);    
});
    

// ============ FUNCTIONS =================

function startGame() {
    console.log('game begins');
    spells = _.shuffle(spells);

    // clear the game field
    startButton.forEach(btn => btn.style.display = 'none');
    if (gameOverField !== null) gameOverField.style.display = 'none';
    gameText.style.display = 'none';
    gameText.style.visibility = 'hidden';

    // set the initial values based on level of game complexity
    gameLevel = this.getAttribute("data-level");
    if (gameLevel === 'easy') {
        easyGameTime = 1;
        timer.value = easyGameTime;
        score.value = '0/15';
        numberOfQuestionsLeft.value = 15;
    } else {
        difficultGameTime = 60;
        timer.value = difficultGameTime;
        score.value = '0/25';
        numberOfQuestionsLeft.value = 25;
    }

    // set initial values to zeros
    totalScore = 0;
    numberOfCorrectAnswers.value = 0;
    numberOfWrongAnswers.value = 0;

    // generate quiz and start timer
    generateQuestion();
    generateOptions();
    timerFunction = setInterval(startTimer, 1000);
}
        


function startTimer() {
    if (gameLevel === 'easy') {
        easyGameTime--;
        timer.value = easyGameTime;
    } else {
        difficultGameTime--;
        timer.value = difficultGameTime;
    }
    if (easyGameTime < 0 || difficultGameTime < 0) {
        clearInterval(timerFunction);
        timer.value = 0;
        finishGame();
    }
}


function generateQuestion() {
    // finish game if all queastions are answered
    if (numberOfQuestionsLeft.value === 0) {
        finishGame();
        clearInterval(timerFunction);
    }

    questionField.textContent = '';

    // generate random question
    const randomIndex = Math.floor(Math.random() * spells.length);
    let randomSpell = spells[randomIndex];
    currentKey = randomSpell.key;

    // check that current spell hasn't been used before
    if (spellsUsed.includes(currentKey)) generateQuestion();
    else {
        spellsUsed.push(currentKey);
        questionIcon.style.visibility = 'visible';
        questionField.textContent += `Spell that ${randomSpell.val}`;
    }
}



function generateOptions() {
    optionsField.innerHTML = '';

   let randomKeys = _.shuffle(allKeys).slice(0, 3);

   if (!randomKeys.includes(currentKey)) {
       randomKeys.shift();
       randomKeys.push(currentKey);
       randomKeys = _.shuffle(randomKeys);
   }
   
   _.each(randomKeys, (key, i) => {
       let node = document.createElement("SPAN"); 
       node.textContent = key;
       node.setAttribute("data-spell", key);
        if (i % 2 == 0) {
            node.className = 'option';
        } else {
            node.className = 'option';
        }
       optionsField.appendChild(node);
   });

   options = document.querySelectorAll('.option');
   _.each(options, (option) => {
        option.addEventListener('click', checkAnswer);
   });
}


function checkAnswer(e) {

    // prevent buttons from clicking on them
    _.each(options, (option) => {
        option.style.pointerEvents = 'none';
    });

    if (this.getAttribute('data-spell') === currentKey) {
        this.classList.add('correct-answer');
        numberOfCorrectAnswers.value++;
        totalScore++;
        score.value = `${totalScore}/15`;
    } else {
        this.classList.add('wrong-answer');
        numberOfWrongAnswers.value++;
    }

    if (numberOfQuestionsLeft.value === '1' || timer.value === '1' || timer.value === 0) {
        setTimeout(() => { 
            finishGame();
        }, 1000);
        return;
    }

    setTimeout(() => { 
        reduceNumberOfQuestionsLeft();
        this.classList.remove('correct-answer');
        this.classList.remove('wrong-answer');
        generateQuestion();
        generateOptions();
    }, 1000);

}


function reduceNumberOfQuestionsLeft() {
    numberOfQuestionsLeft.value--;
    if (numberOfQuestionsLeft.value === '0') {
        finishGame();
    }
}

function finishGame() {
    console.log('game finished');
    numberOfQuestionsLeft.value--;
    questionField.innerHTML = '';
    questionIcon.style.visibility = 'hidden';
    optionsField.innerHTML = '';
    spellsUsed = [];
    let answer = totalScore === 1 ? 'answer' : 'answers';
    gameText.innerHTML = `Game finished! <br> You have ${totalScore} correct ${answer} out of 15`;
    gameText.style.display = 'block';
    gameText.style.visibility = 'visible';
    startButton.forEach(btn => btn.style.display = 'block');
}
